#!/bin/bash

# print_db - Command line interface for database print functions
# Usage: ./print_db [command] [options]

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DB_PATH="$SCRIPT_DIR/out/data/articles.db"

# Function to show dmenu interface
show_dmenu() {
    # Check if dmenu-mac is available first (native macOS), then fallback to dmenu
    local dmenu_cmd=""
    if command -v dmenu-mac >/dev/null 2>&1; then
        dmenu_cmd="dmenu-mac"
    elif command -v dmenu >/dev/null 2>&1; then
        dmenu_cmd="dmenu"
        # Check if we're in a proper X11/display environment for regular dmenu
        if [ -z "$DISPLAY" ] && [ -z "$XDG_SESSION_TYPE" ]; then
            echo "‚ö†Ô∏è  dmenu requires X11/display environment. Using terminal menu instead."
            show_menu
            return
        fi
    else
        echo "‚ùå dmenu-mac or dmenu not found. Please install dmenu-mac or use the regular menu."
        show_menu
        return
    fi

    # Create menu options for dmenu
    menu_options="Database Statistics
All Forthcoming Articles
JF Forthcoming Articles
AER Forthcoming Articles
Latest 5 Articles
Latest 10 Articles
Latest 5 JF Articles
Latest 5 AER Articles
Help
Exit"

    # Show dmenu and get selection (with appropriate options for each version)
    if [ "$dmenu_cmd" = "dmenu-mac" ]; then
        # dmenu-mac with minimal options - center position only
        choice=$(echo "$menu_options" | dmenu-mac -p "Database Print Commands:" -c 2>/dev/null)
    else
        # regular dmenu options
        choice=$(echo "$menu_options" | dmenu -i -l 10 -p "Database Print Commands:" 2>/dev/null)
    fi
    
    # Check if dmenu failed or user cancelled
    if [ -z "$choice" ]; then
        echo "‚ùå dmenu cancelled or failed. Using terminal menu instead."
        show_menu
        return
    fi
    
    # Process the selection
    case "$choice" in
        "Database Statistics")
            check_database
            echo "üìä Database Statistics:"
            echo "Total articles: $(get_article_count)"
            echo "JF articles: $(get_article_count 'jf')"
            echo "AER articles: $(get_article_count 'aer')"
            ;;
        "All Forthcoming Articles")
            check_database
            print_forthcoming_articles
            ;;
        "JF Forthcoming Articles")
            check_database
            print_forthcoming_articles "jf"
            ;;
        "AER Forthcoming Articles")
            check_database
            print_forthcoming_articles "aer"
            ;;
        "Latest 5 Articles")
            check_database
            echo "üì∞ Latest 5 articles:"
            query="SELECT journal, title FROM articles ORDER BY scraped_at DESC LIMIT 5;"
            sqlite3 "$DB_PATH" -separator $'\t' "$query" | {
                article_num=1
                while IFS=$'\t' read -r journal title; do
                    if [ ${#title} -gt 60 ]; then
                        title_preview="${title:0:60}..."
                    else
                        title_preview="$title"
                    fi
                    journal_upper=$(echo "$journal" | tr '[:lower:]' '[:upper:]')
                    echo "$article_num. [$journal_upper] $title_preview"
                    ((article_num++))
                done
            }
            ;;
        "Latest 10 Articles")
            check_database
            echo "üì∞ Latest 10 articles:"
            query="SELECT journal, title FROM articles ORDER BY scraped_at DESC LIMIT 10;"
            sqlite3 "$DB_PATH" -separator $'\t' "$query" | {
                article_num=1
                while IFS=$'\t' read -r journal title; do
                    if [ ${#title} -gt 60 ]; then
                        title_preview="${title:0:60}..."
                    else
                        title_preview="$title"
                    fi
                    journal_upper=$(echo "$journal" | tr '[:lower:]' '[:upper:]')
                    echo "$article_num. [$journal_upper] $title_preview"
                    ((article_num++))
                done
            }
            ;;
        "Latest 5 JF Articles")
            check_database
            echo "üì∞ Latest 5 JF articles:"
            query="SELECT journal, title FROM articles WHERE journal = 'jf' ORDER BY scraped_at DESC LIMIT 5;"
            sqlite3 "$DB_PATH" -separator $'\t' "$query" | {
                article_num=1
                while IFS=$'\t' read -r journal title; do
                    if [ ${#title} -gt 60 ]; then
                        title_preview="${title:0:60}..."
                    else
                        title_preview="$title"
                    fi
                    journal_upper=$(echo "$journal" | tr '[:lower:]' '[:upper:]')
                    echo "$article_num. [$journal_upper] $title_preview"
                    ((article_num++))
                done
            }
            ;;
        "Latest 5 AER Articles")
            check_database
            echo "üì∞ Latest 5 AER articles:"
            query="SELECT journal, title FROM articles WHERE journal = 'aer' ORDER BY scraped_at DESC LIMIT 5;"
            sqlite3 "$DB_PATH" -separator $'\t' "$query" | {
                article_num=1
                while IFS=$'\t' read -r journal title; do
                    if [ ${#title} -gt 60 ]; then
                        title_preview="${title:0:60}..."
                    else
                        title_preview="$title"
                    fi
                    journal_upper=$(echo "$journal" | tr '[:lower:]' '[:upper:]')
                    echo "$article_num. [$journal_upper] $title_preview"
                    ((article_num++))
                done
            }
            ;;
        "Help")
            show_help
            ;;
        "Exit")
            echo "üëã Goodbye!"
            exit 0
            ;;
        *)
            echo "‚ùå Unknown selection: $choice"
            exit 1
            ;;
    esac
}

# Function to show interactive menu
show_menu() {
    echo "üìö Database Print Commands - Interactive Menu"
    echo "=============================================="
    echo "1) Show database statistics"
    echo "2) Show all forthcoming articles"
    echo "3) Show JF forthcoming articles"
    echo "4) Show AER forthcoming articles"
    echo "5) Show latest 5 articles"
    echo "6) Show latest 10 articles"
    echo "7) Show latest 5 JF articles"
    echo "8) Show latest 5 AER articles"
    echo "9) Show help"
    echo "0) Exit"
    echo ""
    echo -n "Please select an option (0-9): "
    read -r choice
    echo ""
    
    case "$choice" in
        1)
            check_database
            echo "üìä Database Statistics:"
            echo "Total articles: $(get_article_count)"
            echo "JF articles: $(get_article_count 'jf')"
            echo "AER articles: $(get_article_count 'aer')"
            ;;
        2)
            check_database
            print_forthcoming_articles
            ;;
        3)
            check_database
            print_forthcoming_articles "jf"
            ;;
        4)
            check_database
            print_forthcoming_articles "aer"
            ;;
        5)
            check_database
            echo "üì∞ Latest 5 articles:"
            query="SELECT journal, title FROM articles ORDER BY scraped_at DESC LIMIT 5;"
            sqlite3 "$DB_PATH" -separator $'\t' "$query" | {
                article_num=1
                while IFS=$'\t' read -r journal title; do
                    if [ ${#title} -gt 60 ]; then
                        title_preview="${title:0:60}..."
                    else
                        title_preview="$title"
                    fi
                    journal_upper=$(echo "$journal" | tr '[:lower:]' '[:upper:]')
                    echo "$article_num. [$journal_upper] $title_preview"
                    ((article_num++))
                done
            }
            ;;
        6)
            check_database
            echo "üì∞ Latest 10 articles:"
            query="SELECT journal, title FROM articles ORDER BY scraped_at DESC LIMIT 10;"
            sqlite3 "$DB_PATH" -separator $'\t' "$query" | {
                article_num=1
                while IFS=$'\t' read -r journal title; do
                    if [ ${#title} -gt 60 ]; then
                        title_preview="${title:0:60}..."
                    else
                        title_preview="$title"
                    fi
                    journal_upper=$(echo "$journal" | tr '[:lower:]' '[:upper:]')
                    echo "$article_num. [$journal_upper] $title_preview"
                    ((article_num++))
                done
            }
            ;;
        7)
            check_database
            echo "üì∞ Latest 5 JF articles:"
            query="SELECT journal, title FROM articles WHERE journal = 'jf' ORDER BY scraped_at DESC LIMIT 5;"
            sqlite3 "$DB_PATH" -separator $'\t' "$query" | {
                article_num=1
                while IFS=$'\t' read -r journal title; do
                    if [ ${#title} -gt 60 ]; then
                        title_preview="${title:0:60}..."
                    else
                        title_preview="$title"
                    fi
                    journal_upper=$(echo "$journal" | tr '[:lower:]' '[:upper:]')
                    echo "$article_num. [$journal_upper] $title_preview"
                    ((article_num++))
                done
            }
            ;;
        8)
            check_database
            echo "üì∞ Latest 5 AER articles:"
            query="SELECT journal, title FROM articles WHERE journal = 'aer' ORDER BY scraped_at DESC LIMIT 5;"
            sqlite3 "$DB_PATH" -separator $'\t' "$query" | {
                article_num=1
                while IFS=$'\t' read -r journal title; do
                    if [ ${#title} -gt 60 ]; then
                        title_preview="${title:0:60}..."
                    else
                        title_preview="$title"
                    fi
                    journal_upper=$(echo "$journal" | tr '[:lower:]' '[:upper:]')
                    echo "$article_num. [$journal_upper] $title_preview"
                    ((article_num++))
                done
            }
            ;;
        9)
            show_help
            ;;
        0)
            echo "üëã Goodbye!"
            exit 0
            ;;
        *)
            echo "‚ùå Invalid option. Please select 0-9."
            echo ""
            show_menu
            ;;
    esac
}

# Function to show help
show_help() {
    echo "üìö Database Print Commands:"
    echo "  ./print_db forthcoming [jf|aer]     - Show forthcoming articles"
    echo "  ./print_db stats                    - Show database statistics"  
    echo "  ./print_db latest [N] [jf|aer]      - Show N latest articles"
    echo "  ./print_db dmenu                    - Show dmenu interface (requires dmenu-mac or dmenu)"
    echo "  ./print_db terminal                 - Force terminal menu (no dmenu)"
    echo "  ./print_db help                     - Show this help"
    echo ""
    echo "Examples:"
    echo "  ./print_db forthcoming              # All forthcoming articles"
    echo "  ./print_db forthcoming jf           # Only JF forthcoming articles"
    echo "  ./print_db forthcoming aer          # Only AER forthcoming articles"
    echo "  ./print_db stats                    # Database statistics"
    echo "  ./print_db latest                   # Latest 5 articles"
    echo "  ./print_db latest 10                # Latest 10 articles"
    echo "  ./print_db latest 5 jf              # Latest 5 JF articles"
    echo "  ./print_db latest 10 aer            # Latest 10 AER articles"
    echo "  ./print_db dmenu                    # Show dmenu interface"
    echo "  ./print_db terminal                 # Show terminal menu"
    echo ""
    echo "Note: Run './print_db' without arguments for auto-detected menu"
    echo "      dmenu provides a graphical selection interface (dmenu-mac preferred on macOS)"
    echo "      terminal menu works in any terminal environment"
}

# Function to check if database exists
check_database() {
    if [ ! -f "$DB_PATH" ]; then
        echo "‚ùå No database found at $DB_PATH"
        exit 1
    fi
}

# Function to get article count
get_article_count() {
    local journal="$1"
    if [ -n "$journal" ]; then
        sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM articles WHERE journal = '$journal';"
    else
        sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM articles;"
    fi
}

# Function to print forthcoming articles
print_forthcoming_articles() {
    local journal="$1"
    local journal_filter=""
    
    if [ -n "$journal" ]; then
        journal_filter=" $journal"
        query="SELECT journal, title, authors, volume, issue, article_link, abstract, scraped_at 
               FROM articles 
               WHERE journal = '$journal' AND (issue = 'forthcoming' OR volume = 'forthcoming')
               ORDER BY journal, scraped_at DESC;"
    else
        query="SELECT journal, title, authors, volume, issue, article_link, abstract, scraped_at 
               FROM articles 
               WHERE issue = 'forthcoming' OR volume = 'forthcoming'
               ORDER BY journal, scraped_at DESC;"
    fi
    
    # Get count first
    if [ -n "$journal" ]; then
        count=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM articles WHERE journal = '$journal' AND (issue = 'forthcoming' OR volume = 'forthcoming');")
    else
        count=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM articles WHERE issue = 'forthcoming' OR volume = 'forthcoming';")
    fi
    
    if [ "$count" -eq 0 ]; then
        echo "üì∞ No${journal_filter} forthcoming articles found in database"
        return
    fi
    
    echo "üì∞ $count$(echo "$journal_filter" | tr '[:lower:]' '[:upper:]') Forthcoming Articles:"
    echo "================================================================================"
    
    # Use sqlite3 with custom formatting
    sqlite3 "$DB_PATH" -separator $'\t' "$query" | {
        article_num=1
        current_journal=""
        
        while IFS=$'\t' read -r journal_name title authors volume issue article_link abstract scraped_at; do
            # Add journal header if it changes
            journal_upper=$(echo "$journal_name" | tr '[:lower:]' '[:upper:]')
            if [ "$current_journal" != "$journal_upper" ]; then
                if [ -n "$current_journal" ]; then
                    echo ""  # Add spacing between journals
                fi
                current_journal="$journal_upper"
                echo ""
                echo "üèõÔ∏è  $current_journal FORTHCOMING ARTICLES:"
                echo "--------------------------------------------------"
            fi
            
            echo ""
            echo "=== Article $article_num ==="
            echo "Title: $title"
            [ -n "$authors" ] && echo "Authors: $authors"
            [ -n "$article_link" ] && echo "Link: $article_link"
            if [ -n "$abstract" ] && [ "$abstract" != "" ]; then
                # Truncate long abstracts to 200 characters
                if [ ${#abstract} -gt 200 ]; then
                    abstract_preview="${abstract:0:200}..."
                else
                    abstract_preview="$abstract"
                fi
                echo "Abstract: $abstract_preview"
            fi
            echo "Scraped: $scraped_at"
            
            ((article_num++))
        done
    }
}

# Main command processing
case "${1:-menu}" in
    "forthcoming")
        check_database
        if [ -n "$2" ]; then
            # Journal filter provided
            if [[ "$2" != "jf" && "$2" != "aer" ]]; then
                echo "‚ùå Journal filter must be 'jf' or 'aer'"
                exit 1
            fi
            print_forthcoming_articles "$2"
        else
            # No filter - show all
            print_forthcoming_articles
        fi
        ;;
    
    "stats")
        check_database
        echo "üìä Database Statistics:"
        echo "Total articles: $(get_article_count)"
        echo "JF articles: $(get_article_count 'jf')"
        echo "AER articles: $(get_article_count 'aer')"
        ;;
    
    "latest")
        check_database
        # Default limit is 5
        limit="${2:-5}"
        journal_filter="$3"
        
        # Validate limit is a number
        if ! [[ "$limit" =~ ^[0-9]+$ ]]; then
            echo "‚ùå Limit must be a number"
            exit 1
        fi
        
        # Validate journal filter if provided
        if [ -n "$journal_filter" ] && [[ "$journal_filter" != "jf" && "$journal_filter" != "aer" ]]; then
            echo "‚ùå Journal filter must be 'jf' or 'aer'"
            exit 1
        fi
        
        # Build SQL query
        if [ -n "$journal_filter" ]; then
            query="SELECT journal, title FROM articles WHERE journal = '$journal_filter' ORDER BY scraped_at DESC LIMIT $limit;"
            journal_upper=$(echo "$journal_filter" | tr '[:lower:]' '[:upper:]')
            echo "üì∞ Latest $limit $journal_upper articles:"
        else
            query="SELECT journal, title FROM articles ORDER BY scraped_at DESC LIMIT $limit;"
            echo "üì∞ Latest $limit articles:"
        fi
        
        # Execute query and format output
        sqlite3 "$DB_PATH" -separator $'\t' "$query" | {
            article_num=1
            while IFS=$'\t' read -r journal title; do
                # Truncate title to 60 characters
                if [ ${#title} -gt 60 ]; then
                    title_preview="${title:0:60}..."
                else
                    title_preview="$title"
                fi
                journal_upper=$(echo "$journal" | tr '[:lower:]' '[:upper:]')
                echo "$article_num. [$journal_upper] $title_preview"
                ((article_num++))
            done
        }
        ;;
    
    "help"|"-h"|"--help")
        show_help
        ;;
    
    "dmenu")
        show_dmenu
        ;;
    
    "terminal")
        show_menu
        ;;
    
    "menu")
        # Auto-detect dmenu availability (prefer dmenu-mac on macOS)
        if command -v dmenu-mac >/dev/null 2>&1; then
            show_dmenu
        elif command -v dmenu >/dev/null 2>&1 && [ -n "$DISPLAY" ]; then
            show_dmenu
        else
            show_menu
        fi
        ;;
    
    *)
        echo "‚ùå Unknown command: $1"
        echo ""
        show_help
        exit 1
        ;;
esac
